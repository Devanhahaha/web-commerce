name: SonarQube Analysis

on:
  push:
    branches:
      - main  # atau sesuaikan dengan branch yang Anda gunakan
  pull_request:
    branches:
      - main  # jika Anda ingin workflow berjalan saat ada pull request ke branch utama

jobs:
  build:
    runs-on: windows-latest  # Menggunakan runner Windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Set environment variables for SonarQube
      - name: Set environment variables
        run: echo "SONAR_HOST_URL=http://localhost:9000" >> $GITHUB_ENV

      # Install dependencies and download SonarQube Scanner
      - name: Install dependencies and run SonarQube Scanner
        run: |
          Invoke-WebRequest -Uri "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-windows.zip" -OutFile "sonar-scanner.zip"
          Expand-Archive -Path "sonar-scanner.zip" -DestinationPath "sonar-scanner"
          $env:PATH += ";$(pwd)\sonar-scanner\bin"  # Menambahkan direktori ke PATH
          
          # Verifikasi isi direktori bin dan PATH
          dir "$(pwd)\sonar-scanner\bin"
          echo $env:PATH

      # Run SonarQube Scanner
      - name: Run SonarQube Scanner
        env:
          SONAR_HOST_URL: 'http://localhost:9000'  # URL server SonarQube
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}  # Token API SonarQube
        run: |
          # Cek path lengkap ke sonar-scanner dan jalankan
          & "$(pwd)\sonar-scanner\bin\sonar-scanner.bat" --version
          & "$(pwd)\sonar-scanner\bin\sonar-scanner.bat"
